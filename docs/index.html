<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Sale Maps ¬∑ –í–∏—Ç—Ä–∏–Ω–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="./style.css" />
</head>

<body>
    <div class="wrap">
        <div class="top">
            <div class="brand">
                <h1>Sale Maps</h1>
                <p>–ì–æ—Ç–æ–≤—ã–µ –ø—É—Ç–µ–≤–æ–¥–∏—Ç–µ–ª–∏ —Ç–æ—á–∫–∞–º–∏ (.kmz) –¥–ª—è Organic Maps / MAPS.ME</p>
            </div>
            <div class="chip">üó∫Ô∏è –ö–∞—Ç–∞–ª–æ–≥</div>
        </div>

        <div id="catalog" class="grid"></div>

        <div class="footer">
            ¬© Sale Maps ¬∑ 2026
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        const isTg = !!tg;
        
        function applyTelegramTheme(){
            if (!isTg) return;
            tg.ready();
            tg.expand();

            const css = document.documentElement.style;
            const scheme = (tg.colorScheme || 'dark').toLowerCase();
            const p = tg.themeParams || {};

            if (scheme === 'light') {
                css.setProperty('--bg',    '#f6f7fb');
                css.setProperty('--card',  '#ffffff');
                css.setProperty('--card2', '#ffffff');
                css.setProperty('--text',  '#0f172a');
                css.setProperty('--muted', '#334155');
                css.setProperty('--stroke','rgba(15, 23, 42, .08)');
                css.setProperty('--btn',   '#eef2ff');
                css.setProperty('--btnText','#0f172a');
                css.setProperty('--shadow','0 18px 40px rgba(15, 23, 42, .10)');
            } else {
                css.setProperty('--bg',    '#0b1220');
                css.setProperty('--card',  '#0f1b33');
                css.setProperty('--card2', '#0c172b');
                css.setProperty('--text',  '#e5e7eb');
                css.setProperty('--muted', '#9aa4b2');
                css.setProperty('--stroke','rgba(255,255,255,.08)');
                css.setProperty('--btn',   '#1f2a44');
                css.setProperty('--btnText','#e5e7eb');
                css.setProperty('--shadow','0 18px 40px rgba(0,0,0,.35)');
            }

            if (p.button_color) css.setProperty('--accent', p.button_color);
            if (p.button_text_color) css.setProperty('--accentText', p.button_text_color);

            try { tg.setHeaderColor?.(scheme === 'light' ? '#f6f7fb' : '#0b1220'); } catch(e){}
            try { tg.setBackgroundColor?.(scheme === 'light' ? '#f6f7fb' : '#0b1220'); } catch(e){}
        }

        function haptic(type='impact', style='light'){
            if (!isTg) return;
            try{
                const hf = tg.HapticFeedback;
                if (!hf) return;
                if (type === 'impact') hf.impactOccurred(style);
                if (type === 'notification') hf.notificationOccurred(style);
            }catch(e){}
        }

        function send(action, productId){
            const payload = JSON.stringify({ action, productId });
            if (!isTg){
                alert('–û—Ç–∫—Ä–æ–π mini-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram.\n\n' + payload);
                return;
            }
            tg.sendData(payload);

            // –∑–∞–∫—Ä—ã–≤–∞–µ–º –±—ã—Å—Ç—Ä–æ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É —É–≤–∏–¥–µ–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ –≤ —á–∞—Ç–µ
            setTimeout(() => { try { tg.close(); } catch(e){} }, 80);
        }

        async function loadProducts(){
            // pages cache –º–æ–∂–µ—Ç –º–µ—à–∞—Ç—å ‚Äî no-store –ø–æ–º–æ–≥–∞–µ—Ç –≤ dev
            const res = await fetch('./products.json', { cache: 'no-store' });
            if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å products.json (HTTP ' + res.status + ')');
            return res.json();
        }

        function escapeHtml(s){
            return String(s ?? '')
                .replaceAll('&','&amp;')
                .replaceAll('<','&lt;')
                .replaceAll('>','&gt;')
                .replaceAll('"','&quot;')
                .replaceAll("'","&#039;");
        }

        function starsLabel(priceStars){
            if (!priceStars || Number(priceStars) <= 0) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ ‚úÖ';
            return `${priceStars} ‚≠ê Stars`;
        }

        function renderCityCard(city, products){
            const cityProducts = products.filter(p => p.cityId === city.id && p.active !== false);
            
            const mini = cityProducts.find(p => p.type === 'mini');
            const full = cityProducts.find(p => p.type === 'full');
            
            const miniPrice = mini ? starsLabel(mini.priceStars) : '';
            const fullPrice = full ? starsLabel(full.priceStars) : '';
            
            const subtitle = `Organic Maps / MAPS.ME ¬∑ .kmz`;
            const cityName = escapeHtml(city.name);
            const country = escapeHtml(city.country || '');
            
            return `
                <div class="card">
                    <div class="cardHeader">
                        <div class="pill">${escapeHtml(subtitle)}</div>
                        <div class="pill">${country ? `${country}` : ' '}</div>
                    </div>

                    <div class="title">${cityName}</div>
                    <p class="lead">–ì–æ—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä —Ç–æ—á–µ–∫: –µ–¥–∞, –≤–∏–¥—ã, –ø—Ä–æ–≥—É–ª–∫–∏, –ø–æ–ª–µ–∑–Ω–æ–µ.</p>

                    <div class="row">
                        ${mini ? `
                            <div class="badge">
                                <div class="t">${escapeHtml(mini.title || 'Mini')}</div>
                                <div class="v">${escapeHtml(mini.subtitle || miniPrice)}</div>
                            </div>` : ''
                        }
                        ${full ? `
                            <div class="badge">
                                <div class="t">${escapeHtml(full.title || 'Full')}</div>
                                <div class="v">${escapeHtml(full.subtitle || fullPrice)}</div>
                            </div>` : ''
                        }
                        <div class="badge">
                            <div class="t">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</div>
                            <div class="v">–í–∫–ª—é—á–µ–Ω—ã ‚ôªÔ∏è</div>
                        </div>
                    </div>

                    <div class="actions">
                        ${mini ? `
                            <button class="btn" data-action="GET_FILE" data-product="${escapeHtml(mini.id)}">
                                ‚úÖ –ó–∞–±—Ä–∞—Ç—å (${escapeHtml(mini.subtitle || miniPrice)})
                            </button>` : ''
                        }
                        
                        ${full ? `
                            <button class="btn primary" data-action="BUY" data-product="${escapeHtml(full.id)}">
                                ‚≠ê –ö—É–ø–∏—Ç—å (${escapeHtml(full.subtitle || fullPrice)})
                            </button>` : ''
                        }
                        
                        <button class="btn ghost" data-action="HOW_TO">
                            ‚ùì –ö–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>

                    <div class="hint">
                        <div class="icon">‚ÑπÔ∏è</div>
                        <div><b>–í–∞–∂–Ω–æ:</b> —Ñ–∞–π–ª <b>.kmz</b> –ø—Ä–∏–¥—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ—Ç –±–æ—Ç–∞ –≤ —ç—Ç–æ—Ç —á–∞—Ç.</div>
                    </div>
                </div>
            `;
        }

        function bindButtons(root){
            root.querySelectorAll('button[data-action]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.getAttribute('data-action');
                    const productId = btn.getAttribute('data-product') || undefined;
                    haptic('impact', action === 'BUY' ? 'medium' : 'light');
                    send(action, productId);
                });
            });
        }

        async function init(){
            applyTelegramTheme();
            
            const catalogEl = document.getElementById('catalog');
            
            try{
                const data = await loadProducts();
                
                const cities = (data.cities || []).filter(c => c && c.active !== false);
                const products = (data.products || []).filter(p => p && p.active !== false);
                
                if (!cities.length){
                    catalogEl.innerHTML = `<div class="error">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –≤ products.json</div>`;
                    return;
                }

                catalogEl.innerHTML = cities.map(c => renderCityCard(c, products)).join('');
                bindButtons(catalogEl);
            }catch(e){
                catalogEl.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞:\n${escapeHtml(e.message || e)}</div>`;
            }
        }

        init();
    </script>
</body>
</html>
